---
contributors: multitudes
---

## Intro

Getting location updates now is as simple as writing this one line of code. This is our new Swift native API, with out of box support for modern swift concurrency to get location updates:

```swift
for try await update in CLLocationUpdate.liveUpdates() {
    print("My current location : \(update.location)")
}
```

- CLLocationUpdate
- Getting updates
- Updates in the background
- Automatic pause / resume
- Process lifecycle

# CLLocationUpdate

Let's explore the structure of the CLocationUpdate API. We are introducing a new class CLLocationUpdate, which has a static function liveUpdates, that returns an AsyncSequence called Updates. Which can directly be iterated using for/try/await, to yield an element of type CLLocationUpdate, that contains a location of type CLLocation, and a boolean flag isStationary for managing automatic, pause and resume. liveUpdates also consumes an optional argument of LiveConfiguration enum type. 

![location updates][location1]

[location1]: ../../../images/notes/wwdc23/10180/location1.jpg

# Getting updates
Now, let's do some code walkthrough and see how we can get updates using this new API. Let's build a basic app that starts location updates from the Foreground. First import CoreLocation. Then we'll call the static factory function liveUpdates provided by the CLLocationUpdate class to get the Updates AsyncSequence. Which can directly be iterated using for/try/await to get a CLLocationUpdate in the closure. And then get the location by accessing its location property. All right, so at this point our updates have started. How about if we have to stop it? Stopping is as simple as breaking from the for loop. Remember isStationary?
Let's break out of the for loop when this isStationary is reported to be true, automatically stopping the updates.

```swift
// Getting Updates
import CoreLocation

let updates = CLLocationUpdate.liveUpdates()

for try await update in updates {
	print ("my location is \(update.location)")
	
	// To stop updates break out of the for loop
	if update.isStationary {
		break
	}
}
```

Let's check out the AsyncSequence returned by CLLocationUpdate API. All the powerful things which we can do over an AsyncSequence like finding, selecting, and excluding elements can also be performed on this updates sequence. In this example, I'll walk you through how we can use the first filter directly on the AsyncSequence. Under the hood updates are started and the location of each element is checked for speed. As soon as an update whose speed is more than 200 is found, that first element will be returned, completing the operation. Updates will automatically stop once the first match is found.
```swift
// Getting Updates
import CoreLocation

let updates = CLLocationUpdate.liveUpdates()

let update = try await updates.first(where: {($0.location?.speed ?? 0) > 200.0})

print("speed is : \(update?.location?.speed)")
// Be careful - execution will get stuck until a match is found
```

But did you notice the speed here? This is 200 meter per second, so roughly around 447 miles per hour. That's too fast, right? 

So we need to be careful while using these filters because execution will get stuck until a match is found, and be even more careful if you try using this for filtering the locations based on horizontalAccuracy.

Back to our sample code from the previous slide for getting updates where we are not specifying any configuration to liveUpdates. 

So they are configured automatically with a default config.

```swift
	let updates = CLLocationUpdate.liveUpdates()
```

But liveUpdates API can take an explicit configuration. This configuration is a new enum type which we are introducing as part of this API.

```swift
	let updates = CLLocationUpdate.liveUpdates(.automotiveNavigation)
```

Let's see what are the members of this enum type and their use. LiveConfiguration enum is a collection of pre-baked configurations an app can choose from to start the updates. It has default, automotiveNavigation, otherNavigation, fitness, and airborne as its members.

```swift
// LiveConfiguration possible values

public enum LiveConfiguration {
	
	case default
	case automotiveNavigation
	case otherNavigation
	case fitness
	case airborne
}
```

If your app is already using a particular CLActivityType with existing location updates API, then you can choose a corresponding LiveConfiguration member to have the same location experience while adopting the new API. But if you don't have the need for a specific activityType, then you can start the updates either with default configuration or don't specify any configuration at all. So what does this "updates" AsyncSequence yield? When you iterate it, it gives you an object, which is of type CLLocationUpdate. It contains an optional location of type CLLocation. If no location is available, we deliver an update with location marked as nil. It also contains a boolean property isStationary through which we manage automatic pause / resume of location updates.

```swift
public struct CLLocationUpdate : Sendable {
	public let location : CLLocation? // nil if no location is available
	public let isStationary : Bool // true if device becomes stationary
}
```

![location updates][location2]

[location2]: ../../../images/notes/wwdc23/10180/location2.jpg


# Updates in the background
All right, so we just covered how to get updates from the foreground. Now let's talk about how to get updates when your app is running in the background. LiveActivity is the best way to enable background location updates. As long as your LiveActivity remains active, your app can receive updates without any other additional setup. But don't worry if your app doesn't have a LiveActivity yet. This won't be a blocker for adopting the new API. Instead you can use CLBackgroundActivitySession. Let's explore how it works. Many of you might already be familiar with this blue background location indicator, which is displayed when an app authorized as While Using gets updates in the background. CLBackgroundActivitySession uses the same indicator to provide background location capability to your app. It does so by maintaining the visibility for user regarding location services being used in the background. And since the visibility is maintained, it keeps the app effectively in-use letting it access locations even from the background. CLBackgroundActivitySession supports the app's authorization as a whole. So it will enable your app not only to receive updates while in the background, but also to monitor for events using CLMonitor. BackgroundActivitySession has no dependency on Updates being started. Just creating the session displays the indicator when your app is in the background, letting it receive updates and events as needed. In order to use CLBackgroundActivitySession, you need to instantiate it and hold it. Be cautious about the hold part, because object deallocation will automatically invalidate the session potentially ending your app's access to background location. Your app still needs to have location in its UIBackgroundModes array, in order for BackgroundActivitySession to work effectively. If you don't have an outstanding session, then you must start the new session from the foreground, but you can only rejoin an existing one from the the background. Let's do a quick code walk through and see how to use backgroundActivitySession. This is our same "how to get updates" code slide from the previous section.



## Resources

[Adopting live updates in Core Location](https://developer.apple.com/documentation/corelocation/adopting_live_updates_in_core_location)  
[Core Location](https://developer.apple.com/documentation/corelocation)  
[Have a question? Ask with tag wwdc2023-10180](https://developer.apple.com/forums/create/question?&tag1=76&tag2=687030)  
[Monitoring location changes with Core Location](https://developer.apple.com/documentation/corelocation/monitoring_location_changes_with_core_location)  
[Search the forums for tag wwdc2023-10180](https://developer.apple.com/forums/tags/wwdc2023-10180)  

## Related Videos 
[Meet Core Location for spatial computing - WWDC23](https://developer.apple.com/videos/play/wwdc2023/10146)  
[Meet Core Location Monitor - WWDC23](https://developer.apple.com/videos/play/wwdc2023/10147)  


